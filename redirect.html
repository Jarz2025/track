<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecting...</title>
    <script>
        // Immediately start processing the redirect
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const target = urlParams.get('target');
            const id = urlParams.get('id');
            
            if (!target || !id) {
                console.error('Missing target or id parameter');
                return;
            }

            // Create basic tracking data
            const trackingData = {
                id: id,
                target: target,
                timestamp: new Date().toISOString(),
                referrer: document.referrer || 'Direct',
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                screenWidth: window.screen.width,
                screenHeight: window.screen.height,
                language: navigator.language,
                deviceId: generateDeviceId()
            };

            // Save initial data immediately
            saveTrackingData(trackingData);

            // Start IP location fetch in background (won't block redirect)
            fetchIpData(trackingData);

            // Perform redirect as quickly as possible
            try {
                window.location.href = ensureHttp(target);
            } catch (e) {
                console.error('Redirect failed:', e);
                window.location.href = 'https://google.com';
            }
        });

        // Helper function to generate device fingerprint
        function generateDeviceId() {
            const info = navigator.userAgent + navigator.platform + navigator.language + 
                        window.screen.width + window.screen.height;
            let hash = 0;
            for (let i = 0; i < info.length; i++) {
                hash = (hash << 5) - hash + info.charCodeAt(i);
                hash |= 0;
            }
            return hash.toString();
        }

        // Ensure URL has http/https protocol
        function ensureHttp(url) {
            if (!/^https?:\/\//i.test(url)) {
                return 'http://' + url;
            }
            return url;
        }

        // Save tracking data to localStorage
        function saveTrackingData(data) {
            try {
                const logs = JSON.parse(localStorage.getItem('trackingLogs') || '[]');
                
                // Remove existing entry with same ID if exists
                const existingIndex = logs.findIndex(log => log.id === data.id);
                if (existingIndex !== -1) {
                    logs.splice(existingIndex, 1);
                }
                
                // Add new data
                logs.push(data);
                localStorage.setItem('trackingLogs', JSON.stringify(logs));
            } catch (e) {
                console.error('Failed to save tracking data:', e);
            }
        }

        // Fetch IP and location data (runs in background)
        function fetchIpData(trackingData) {
            fetch('https://ipapi.co/json/')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(ipData => {
                    // Update tracking data with IP info
                    const updatedData = {
                        ...trackingData,
                        ip: ipData.ip || 'Unknown',
                        country: ipData.country_name || 'Unknown',
                        region: ipData.region || 'Unknown',
                        city: ipData.city || 'Unknown',
                        latitude: ipData.latitude,
                        longitude: ipData.longitude
                    };
                    
                    // Save updated data
                    saveTrackingData(updatedData);
                })
                .catch(error => {
                    console.error('Error fetching IP data:', error);
                    // Save basic data without IP info if fetch fails
                    const fallbackData = {
                        ...trackingData,
                        ip: 'Unknown',
                        country: 'Unknown',
                        region: 'Unknown',
                        city: 'Unknown'
                    };
                    saveTrackingData(fallbackData);
                });
        }
    </script>
</head>
<body>
    <!-- Empty page for instant redirect -->
</body>
</html>
