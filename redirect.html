<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Redirecting...</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBclCbI9SudcBc6BR17Un8SNWTdzpGl29g",
      authDomain: "jarsi-df353.firebaseapp.com",
      databaseURL: "https://jarsi-df353-default-rtdb.firebaseio.com",
      projectId: "jarsi-df353",
      storageBucket: "jarsi-df353.appspot.com",
      messagingSenderId: "488797085147",
      appId: "1:488797085147:web:52108c710556a39f62dbfe"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get URL params
    const urlParams = new URLSearchParams(window.location.search);
    const target = urlParams.get('target');
    const id = urlParams.get('id');

    // Generate device ID
    function getDeviceId() {
      const info = navigator.userAgent + navigator.platform + navigator.language;
      let hash = 0;
      for (let i = 0; i < info.length; i++) {
        hash = (hash << 5) - hash + info.charCodeAt(i);
        hash |= 0;
      }
      return hash.toString();
    }

    // Collect tracking data
    const trackingData = {
      id,
      target,
      timestamp: new Date().toISOString(),
      referrer: document.referrer || 'Direct',
      userAgent: navigator.userAgent,
      platform: navigator.platform,
      screenWidth: window.screen.width,
      screenHeight: window.screen.height,
      language: navigator.language,
      deviceId: getDeviceId()
    };

    // Fetch IP data and save to Firebase
    Promise.race([
      fetch('https://ipapi.co/json/')
        .then(res => res.ok ? res.json() : Promise.reject())
        .then(ipData => {
          trackingData.ip = ipData.ip;
          trackingData.city = ipData.city;
          trackingData.region = ipData.region;
          trackingData.country = ipData.country_name;
          trackingData.latitude = ipData.latitude;
          trackingData.longitude = ipData.longitude;
        })
        .catch(() => {
          trackingData.ip = 'Unknown';
        }),
      new Promise(resolve => setTimeout(resolve, 500)) // Max 500ms wait for IP
    ]).then(() => {
      set(ref(db, `logs/${id}`), trackingData).catch(console.error);
      window.location.href = target.startsWith('http') ? target : `https://${target}`;
    });
  </script>
</head>
<body></body>
</html>
